# MQTT æ¸¬è©¦æŒ‡å—

æœ¬æŒ‡å—èªªæ˜å¦‚ä½•æ¸¬è©¦ MQTT è¨Šæ¯ç™¼é€å’Œ Streamlit æ‡‰ç”¨ç¨‹å¼çš„æ¥æ”¶åŠŸèƒ½ã€‚

## æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Python æ¸¬è©¦è…³æœ¬ï¼ˆæ¨è–¦ï¼‰

### 1. åŸ·è¡Œæ¸¬è©¦è…³æœ¬

```bash
cd lesson6
uv run python test_mqtt_publisher.py
```

### 2. é¸æ“‡æ¸¬è©¦é …ç›®

è…³æœ¬æœƒé¡¯ç¤ºé¸å–®ï¼Œæ‚¨å¯ä»¥é¸æ“‡ï¼š
- **é¸é … 1**: æ¸¬è©¦é›»ç‡ˆç‹€æ…‹ï¼ˆé–‹å•Ÿï¼‰
- **é¸é … 2**: æ¸¬è©¦é›»ç‡ˆç‹€æ…‹ï¼ˆé—œé–‰ï¼‰
- **é¸é … 3**: æ¸¬è©¦æ„Ÿæ¸¬å™¨æ•¸æ“šï¼ˆå–®ç­†ï¼Œå¯è‡ªè¨‚æº«æ¿•åº¦ï¼‰
- **é¸é … 4**: é€£çºŒç™¼é€å¤šç­†æ„Ÿæ¸¬å™¨æ•¸æ“šï¼ˆç”¨æ–¼æ¸¬è©¦åœ–è¡¨ï¼‰
- **é¸é … 5**: å®Œæ•´æ¸¬è©¦ï¼ˆåŸ·è¡Œæ‰€æœ‰æ¸¬è©¦é …ç›®ï¼‰

### 3. è§€å¯Ÿ Streamlit æ‡‰ç”¨ç¨‹å¼

åœ¨ç™¼é€æ¸¬è©¦è¨Šæ¯æ™‚ï¼Œè§€å¯Ÿ Streamlit æ‡‰ç”¨ç¨‹å¼ï¼š
- é›»ç‡ˆç‹€æ…‹æ‡‰è©²æœƒæ›´æ–°
- æº«åº¦å’Œæ¿•åº¦æ•¸å€¼æ‡‰è©²æœƒé¡¯ç¤º
- åœ–è¡¨æ‡‰è©²æœƒé¡¯ç¤ºæ•¸æ“šé»
- è¨Šæ¯æ­·å²è¨˜éŒ„æ‡‰è©²æœƒå¢åŠ 

## æ–¹æ³•äºŒï¼šä½¿ç”¨å‘½ä»¤è¡Œå·¥å…· (mosquitto_pub)

### å®‰è£ mosquitto å®¢æˆ¶ç«¯å·¥å…·

```bash
sudo apt-get install mosquitto-clients
```

### æ¸¬è©¦é›»ç‡ˆç‹€æ…‹

#### ç™¼é€ã€Œé–‹å•Ÿã€ç‹€æ…‹
```bash
mosquitto_pub -h 192.168.0.252 -p 1883 -u pi -P raspberry \
  -t "å®¢å»³/light" -m '{"status":"on","timestamp":"2025-01-01 12:00:00"}' -q 1
```

#### ç™¼é€ã€Œé—œé–‰ã€ç‹€æ…‹
```bash
mosquitto_pub -h 192.168.0.252 -p 1883 -u pi -P raspberry \
  -t "å®¢å»³/light" -m '{"status":"off","timestamp":"2025-01-01 12:00:00"}' -q 1
```

### æ¸¬è©¦æ„Ÿæ¸¬å™¨æ•¸æ“š

```bash
mosquitto_pub -h 192.168.0.252 -p 1883 -u pi -P raspberry \
  -t "å®¢å»³/sensor" -m '{"timestamp":"2025-01-01 12:00:00","temperature":25.5,"humidity":60.0,"status":"æ­£å¸¸"}' -q 1
```

### é€£çºŒç™¼é€å¤šç­†æ•¸æ“šï¼ˆæ¸¬è©¦åœ–è¡¨ï¼‰

```bash
# ç™¼é€ 10 ç­†æ•¸æ“šï¼Œæ¯ 2 ç§’ä¸€ç­†
for i in {1..10}; do
  temp=$(echo "20 + $i * 0.5" | bc)
  hum=$(echo "50 + $i * 1" | bc)
  mosquitto_pub -h 192.168.0.252 -p 1883 -u pi -P raspberry \
    -t "å®¢å»³/sensor" \
    -m "{\"timestamp\":\"$(date '+%Y-%m-%d %H:%M:%S')\",\"temperature\":$temp,\"humidity\":$hum,\"status\":\"æ­£å¸¸\"}" \
    -q 1
  sleep 2
done
```

## æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ Python äº’å‹•å¼è…³æœ¬

### å¿«é€Ÿæ¸¬è©¦è…³æœ¬

å»ºç«‹ä¸€å€‹ç°¡å–®çš„æ¸¬è©¦è…³æœ¬ `quick_test.py`:

```python
import paho.mqtt.client as mqtt
import json
from datetime import datetime

# é€£æ¥è¨­å®š
client = mqtt.Client()
client.username_pw_set("pi", "raspberry")
client.connect("192.168.0.252", 1883, 60)
client.loop_start()

# æ¸¬è©¦é›»ç‡ˆ
data = {"status": "on", "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
client.publish("å®¢å»³/light", json.dumps(data, ensure_ascii=False), qos=1)

# æ¸¬è©¦æ„Ÿæ¸¬å™¨
data = {
    "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
    "temperature": 25.5,
    "humidity": 60.0,
    "status": "æ­£å¸¸"
}
client.publish("å®¢å»³/sensor", json.dumps(data, ensure_ascii=False), qos=1)

print("âœ… æ¸¬è©¦è¨Šæ¯å·²ç™¼é€")
client.loop_stop()
client.disconnect()
```

åŸ·è¡Œï¼š
```bash
uv run python quick_test.py
```

## æ–¹æ³•å››ï¼šä½¿ç”¨ Jupyter Notebook

æ‚¨å¯ä»¥ä½¿ç”¨ç¾æœ‰çš„ `lesson6_1.ipynb` ä¾†ç™¼é€æ¸¬è©¦è¨Šæ¯ã€‚

### åœ¨ Notebook ä¸­ç™¼é€æ¸¬è©¦è¨Šæ¯

```python
import paho.mqtt.client as mqtt
import json
from datetime import datetime

# é€£æ¥è¨­å®šï¼ˆä½¿ç”¨ç¾æœ‰çš„é€£æ¥ï¼‰
# å‡è¨­æ‚¨å·²ç¶“åœ¨ notebook ä¸­å»ºç«‹äº† client

# æ¸¬è©¦é›»ç‡ˆç‹€æ…‹
topic = "å®¢å»³/light"
data = {
    "status": "on",
    "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
}
message = json.dumps(data, ensure_ascii=False)
result = client.publish(topic, message, qos=1)
print(f"âœ… é›»ç‡ˆç‹€æ…‹å·²ç™¼é€: {message}")

# æ¸¬è©¦æ„Ÿæ¸¬å™¨æ•¸æ“š
topic = "å®¢å»³/sensor"
data = {
    "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
    "temperature": 25.5,
    "humidity": 60.0,
    "status": "æ­£å¸¸"
}
message = json.dumps(data, ensure_ascii=False)
result = client.publish(topic, message, qos=1)
print(f"âœ… æ„Ÿæ¸¬å™¨æ•¸æ“šå·²ç™¼é€: {message}")
```

## æ¸¬è©¦æª¢æŸ¥æ¸…å–®

### åœ¨ Streamlit æ‡‰ç”¨ç¨‹å¼ä¸­æª¢æŸ¥ï¼š

- [ ] **é€£æ¥ç‹€æ…‹**
  - å´é‚Šæ¬„é¡¯ç¤ºã€ŒğŸŸ¢ å·²é€£æ¥ã€
  - ä¸»é é¢é¡¯ç¤ºã€Œâœ… MQTT å·²é€£æ¥ã€

- [ ] **é›»ç‡ˆç‹€æ…‹**
  - ç™¼é€ `{"status":"on"}` å¾Œï¼Œé›»ç‡ˆç‹€æ…‹å¡ç‰‡é¡¯ç¤ºã€ŒğŸŸ¢ é–‹å•Ÿã€
  - ç™¼é€ `{"status":"off"}` å¾Œï¼Œé›»ç‡ˆç‹€æ…‹å¡ç‰‡é¡¯ç¤ºã€Œâš« é—œé–‰ã€
  - é¡¯ç¤ºæœ€å¾Œæ›´æ–°æ™‚é–“

- [ ] **æ„Ÿæ¸¬å™¨æ•¸æ“š**
  - æº«åº¦æ•¸å€¼æ­£ç¢ºé¡¯ç¤º
  - æ¿•åº¦æ•¸å€¼æ­£ç¢ºé¡¯ç¤º
  - æ•¸å€¼æœƒå³æ™‚æ›´æ–°

- [ ] **åœ–è¡¨**
  - åœ–è¡¨é¡¯ç¤ºæº«åº¦å’Œæ¿•åº¦æ›²ç·š
  - X è»¸ç‚ºæ™‚é–“
  - Y è»¸é¡¯ç¤ºæ­£ç¢ºçš„æ•¸å€¼ç¯„åœ
  - é€£çºŒç™¼é€å¤šç­†æ•¸æ“šæ™‚ï¼Œåœ–è¡¨æœƒæ›´æ–°

- [ ] **è¨Šæ¯æ­·å²è¨˜éŒ„**
  - å±•é–‹ã€Œè¨Šæ¯æ­·å²è¨˜éŒ„ã€å¯ä»¥çœ‹åˆ°æ”¶åˆ°çš„è¨Šæ¯
  - è¨Šæ¯åŒ…å«æ­£ç¢ºçš„æ™‚é–“æˆ³è¨˜å’Œæ•¸æ“š

- [ ] **Excel åŒ¯å‡º**
  - é»æ“Šã€ŒåŒ¯å‡ºç‚º Excelã€å¯ä»¥ä¸‹è¼‰æª”æ¡ˆ
  - Excel æª”æ¡ˆåŒ…å«æ‰€æœ‰æ¬„ä½ï¼ˆæ™‚é–“æˆ³è¨˜ã€ä¸»é¡Œã€æº«åº¦ã€æ¿•åº¦ã€é›»ç‡ˆç‹€æ…‹ã€åŸå§‹ JSONï¼‰

## å¸¸è¦‹å•é¡Œæ’æŸ¥

### å•é¡Œ 1: Streamlit æ²’æœ‰æ”¶åˆ°è¨Šæ¯

**å¯èƒ½åŸå› ï¼š**
- MQTT é€£æ¥æœªæˆåŠŸ
- ä¸»é¡Œåç¨±ä¸åŒ¹é…
- JSON æ ¼å¼éŒ¯èª¤

**è§£æ±ºæ–¹æ³•ï¼š**
1. æª¢æŸ¥ Streamlit å´é‚Šæ¬„çš„é€£æ¥ç‹€æ…‹
2. ç¢ºèªä¸»é¡Œåç¨±å®Œå…¨ä¸€è‡´ï¼ˆåŒ…æ‹¬ä¸­æ–‡å­—ç¬¦ï¼‰
3. æª¢æŸ¥ JSON æ ¼å¼æ˜¯å¦æ­£ç¢ºï¼ˆå¯ä»¥ä½¿ç”¨ JSON é©—è­‰å·¥å…·ï¼‰

### å•é¡Œ 2: é›»ç‡ˆç‹€æ…‹æ²’æœ‰æ›´æ–°

**å¯èƒ½åŸå› ï¼š**
- JSON ä¸­ç¼ºå°‘ `status` æ¬„ä½
- `status` å€¼ä¸æ˜¯ "on" æˆ– "off"

**è§£æ±ºæ–¹æ³•ï¼š**
ç¢ºä¿ JSON æ ¼å¼ç‚ºï¼š
```json
{
  "status": "on",
  "timestamp": "2025-01-01 12:00:00"
}
```

### å•é¡Œ 3: åœ–è¡¨æ²’æœ‰é¡¯ç¤ºæ•¸æ“š

**å¯èƒ½åŸå› ï¼š**
- æ„Ÿæ¸¬å™¨æ•¸æ“šæ ¼å¼éŒ¯èª¤
- ç¼ºå°‘ `temperature` æˆ– `humidity` æ¬„ä½

**è§£æ±ºæ–¹æ³•ï¼š**
ç¢ºä¿ JSON æ ¼å¼ç‚ºï¼š
```json
{
  "timestamp": "2025-01-01 12:00:00",
  "temperature": 25.5,
  "humidity": 60.0,
  "status": "æ­£å¸¸"
}
```

### å•é¡Œ 4: é€£æ¥å¤±æ•—

**å¯èƒ½åŸå› ï¼š**
- MQTT Broker æœªé‹è¡Œ
- ç¶²è·¯é€£æ¥å•é¡Œ
- èªè­‰è³‡è¨ŠéŒ¯èª¤

**è§£æ±ºæ–¹æ³•ï¼š**
1. æª¢æŸ¥ MQTT Broker ç‹€æ…‹ï¼š`sudo systemctl status mosquitto`
2. æª¢æŸ¥ç¶²è·¯é€£æ¥ï¼š`ping 192.168.0.252`
3. ç¢ºèªç”¨æˆ¶åå’Œå¯†ç¢¼æ­£ç¢º

## æ¸¬è©¦å»ºè­°

1. **å…ˆæ¸¬è©¦é€£æ¥**ï¼šç¢ºä¿ Streamlit å¯ä»¥é€£æ¥åˆ° MQTT Broker
2. **å–®ç­†æ¸¬è©¦**ï¼šå…ˆç™¼é€å–®ç­†è¨Šæ¯ï¼Œç¢ºèªæ ¼å¼æ­£ç¢º
3. **é€£çºŒæ¸¬è©¦**ï¼šç™¼é€å¤šç­†æ•¸æ“šæ¸¬è©¦åœ–è¡¨åŠŸèƒ½
4. **éŒ¯èª¤æ¸¬è©¦**ï¼šå˜—è©¦ç™¼é€éŒ¯èª¤æ ¼å¼çš„ JSONï¼Œç¢ºèªéŒ¯èª¤è™•ç†æ­£å¸¸

## ç›¸é—œæ–‡ä»¶

- `test_mqtt_publisher.py` - Python æ¸¬è©¦è…³æœ¬
- `app.py` - Streamlit æ‡‰ç”¨ç¨‹å¼
- `PRD.md` - ç”¢å“éœ€æ±‚æ–‡ä»¶
- `MQTT_BROKER_SETUP.md` - MQTT Broker è¨­å®šèªªæ˜

